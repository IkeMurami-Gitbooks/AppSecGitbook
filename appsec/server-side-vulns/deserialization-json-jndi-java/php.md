# PHP

## Как выглядят сериализованные данные в PHP

```php
$user->name = "carlos";
$user->isLoggedIn = true;
```

Функции, которые ищем в коде:

```php
serialize()
unserialize()
```

Serialized:

```
O:4:"User":2:{s:4:"name":s:6:"carlos"; s:10:"isLoggedIn":b:1;}
```

## Gadgets

Для поиска гаджетов обращаем внимание на magic methods (`__wakeup()`, `__sleep()`, `__get()` и др) и обычные функции (например, `call_user_func`). Подроднее смотри в разделе по программированию на PHP.

## PHAR

PHP иногда можно использовать десериализацию, даже если нет очевидного использования метода `unserialize()`. PHP предоставляет несколько оболочек в стиле URL, которые вы можете использовать для обработки различных протоколов при доступе к путям к файлам. Одним из них является оболочка `phar://`, которая предоставляет потоковый интерфейс для доступа к файлам PHP-архива (`.phar`).

Документация PHP показывает, что файлы манифеста PHAR содержат сериализованные метаданные. Важно отметить, что если вы выполняете какие-либо операции файловой системы с потоком `phar://`, эти метаданные неявно десериализуются. Это означает, что поток `phar://` потенциально может быть вектором для использования небезопасной десериализации, при условии, что вы можете передать этот поток в метод файловой системы.

В случае явно опасных методов файловой системы, таких как `include()` или `fopen()`, веб-сайты, скорее всего, внедрили контрмеры, чтобы уменьшить вероятность их злонамеренного использования. Однако такие методы, как `file_exists()`, которые не столь явно опасны, могут быть не так хорошо защищены.

Этот метод также требует, чтобы вы каким-то образом загрузили PHAR на сервер. Например, один из подходов заключается в использовании функции загрузки изображений. Если вы можете создать полиглот-файл с PHAR, маскирующимся под простой JPG, вы иногда можете обойти проверки веб-сайта. Если вы сможете заставить веб-сайт загружать этот полиглот «JPG» из потока `phar://`, любые вредоносные данные, которые вы вводите через метаданные PHAR, будут десериализованы. Поскольку расширение файла не проверяется, когда PHP читает поток, не имеет значения, использует ли файл расширение изображения.

Пока класс объекта поддерживается веб-сайтом, магические методы `__wakeup()` и `__destruct()` могут быть вызваны таким образом, что потенциально позволяет запустить цепочку гаджетов с помощью этой техники.

Атака примерно так выглядит:

* Нахожим гаджет
* Формируем phar архив
* Ищем полиглот под определенный формат, если требуется (например, phar gif polyglot)
* Запускаем наш файл на десериализацию через phar://your.gif

По умолчанию, создание phar архивов не поддерживается php, надо прописать в конфиге php.ini пункт про phar:

```ini
[phar]
phar.readonly = 0
```

Далее с этим конфигом запускаем скрипт:

```
php -c php.ini your.php
```

## Tools

Есть инструменты, которые содержат в себе уже прекомпиленные гаджеты для известных библиотек. И позволяют удобно генерить свои гаджеты.

### PHP Generic Gadget Chains (PHPGGC)

[phpgcc](https://github.com/ambionics/phpggc) — подготовленные гаджеты под известные десеры

Пример использования:

```bash
./phpgcc -l
./phpggc Symfony/RCE4 exec 'rm /home/carlos/morale.txt' | base64 
```
